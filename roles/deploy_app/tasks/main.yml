- name: Start Minikube cluster
  shell: minikube start --driver=docker --force
  args:
    creates: /home/{{ ansible_user }}/.minikube

- name: Wait for Minikube to be ready
  pause:
    seconds: 180

- name: Check Minikube status
  shell: minikube status
  register: minikube_status
  until: "'Running' in minikube_status.stdout"
  retries: 5
  delay: 10

- name: Set kubectl context to Minikube
  shell: kubectl config use-context minikube

- name: Pull application Docker image
  shell: docker pull busybox

- name: Deploy application deployment
  copy:
    src: "{{ playbook_dir }}/roles/deploy_app/templates/init-container-deployment.yaml"
    dest: /home/{{ ansible_user }}/init-container-deployment.yaml

- name: Apply deployment configuration
  shell: kubectl apply -f /home/{{ ansible_user }}/init-container-deployment.yaml --validate=false
  args:
    executable: /bin/bash
